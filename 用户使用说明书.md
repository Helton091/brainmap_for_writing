# 写作辅助软件（节点图谱）用户使用说明书

## 1. 软件简介
本软件专为写作设计，以“节点”为核心，通过可视化图谱管理事件流和逻辑关系。软件支持无限画布、时间轴布局、精确时间记录以及灵活的节点/链路管理功能。

## 2. 启动方式
### 2.1 安装依赖
本项目使用 Python 运行，依赖通过 `requirements.txt` 管理。首次使用请先安装依赖：

```bash
python -m pip install -r requirements.txt
```

主要依赖如下：
- `PySide6`：Qt 图形界面库（用于渲染节点图谱界面）

### 2.2 启动命令
在项目根目录执行以下命令启动软件：

```bash
.\.venv\Scripts\python.exe -m brainmap_for_writing
```

## 3. 基础操作

### 3.1 创建节点
有两种方式创建节点：
1. **工具栏按钮**：点击工具栏的 `New Node`，在视图中心生成新节点。
2. **鼠标右键**：在画布任意空白处点击鼠标右键，选择 `New Node Here`，在鼠标当前位置直接生成节点。

### 3.2 编辑节点
1. **选中节点**：点击节点选中。
2. **编辑内容**：点击工具栏 `Edit`，或双击节点（如果支持）。
3. **输入信息**：
   - **Date**：支持 `YYYY-MM-DD` 或 `YYYY-MM-DD HH:MM:SS` 格式。如果不输入时间，默认为 `00:00:00`。
   - **Text**：输入事件正文。
4. **显示效果**：节点在画布上仅显示为小圆点（或包含极简日期），鼠标悬停时显示完整正文。

### 3.3 删除与撤销（仅删除可撤销）
- **删除选中内容**：选中节点/箭头后按 `Delete` 键。
- **右键删除**：右键节点或箭头，选择 `Delete`。
- **撤销删除**：按 `Ctrl+Z` 撤销最近一次删除（只覆盖删除操作，不覆盖编辑/导入/自动布局等）。

### 3.4 移动与导航
本软件采用**无限画布**设计，无边界限制：
- **移动节点**：直接拖拽节点即可。
- **画布漫游**：
  - **WASD 键**：键盘 W/A/S/D 控制画布上下左右平移。
  - **鼠标拖拽**：按住鼠标中键或使用滚动条拖拽画布。
- **快速归位**：点击工具栏的 `Go to Start` 按钮，视图将自动跳转到**最早发生事件的节点**位置。
- **缩放**：使用 `Ctrl + 鼠标滚轮` 或工具栏的 `Zoom In` / `Zoom Out`。

### 3.5 节点右键菜单（写作相关）
右键点击节点可用以下功能：
- `Set Memory Block`：为节点填写“memory block”（用来概述该节点对应的故事内容，便于 AI 后续创作时快速读取）。
- `Link Story TXT`：为节点关联一个外部 txt 文件（应用只保存路径，不保存文件内容）。
- `Open Story TXT`：若已关联 txt，可直接从应用内打开该文件。
- `Export`：导出 AI 友好提示词 txt（见下文 6.4）。

## 4. 导入 TXT 生成图谱

### 4.1 导入格式
支持将 TXT 文本批量导入为节点。格式如下：

```text
【2200.07.10】
这是事件A的内容...

【2200.08.03 14:30:00】
这是精确到秒的事件B内容...
```

- **日期标记**：支持 `【YYYY.MM.DD】`、`【YYYY-MM-DD】` 以及带时间的 `【YYYY-MM-DD HH:MM:SS】`。
- **自动补全**：如果只写日期，时间自动补全为 `00:00:00`。
- **冲突检测**：导入时会自动检测时间冲突。如果文本中的时间点在现有图谱中已存在，系统将**跳过该条目**，防止重复导入。

### 4.2 执行导入
点击工具栏 `Import TXT` 选择文件即可。导入后会自动执行一次基于时间的水平布局。

## 5. 连线与折叠（Hide/Expand）

### 5.1 建立连线
1. 点击工具栏 `Connect` 进入连线模式。
2. 先点击起点节点，再点击终点节点，即可创建箭头。

### 5.2 链路折叠与展开
箭头具有管理后续链路显示状态的功能：
- **折叠/展开按钮**：箭头中央显示 `+`（已折叠）或 `-`（已展开）按钮。
- **操作**：点击 `-` 号，将隐藏该箭头指向的节点及其后续所有节点；点击 `+` 号恢复显示。
- **折叠注释**：当链路处于折叠状态（显示 `+`）时，**右键点击加号**，可以设置一段极简注释，用于提示被隐藏的内容。

## 6. 视图与布局管理

### 6.1 时间显示设置
点击工具栏 `Display Settings`：
- `Date Display`：切换日期模式 / 详细时间模式。
- `Node Size`：调整节点大小。
- `Edge Thickness`：调整箭头线条粗细。

### 6.2 自动布局
点击 `Auto Layout`：
- **水平分布**：根据时间先后，将节点在水平方向上排列（时间越晚越靠右）。
- **垂直紧凑**：在垂直方向上自动消除间隙，使图谱更紧凑。

### 6.3 图例管理 (Legend)
界面右侧提供图例面板：
- **添加/删除**：点击 `Add` / `Remove` 管理颜色分类。
- **编辑说明**：双击图例列表中的 Label 列，可直接编辑该颜色的文字说明。
- **显隐图例**：点击工具栏的 `Legend` 按钮可显示或隐藏图例面板。

### 6.4 项目文档面板（系统提示词 / 世界观）
左上角固定两个面板：`System Prompt` 与 `World Document`：
- 可直接编辑，保存/打开项目时会一并持久化。
- 支持 `Import TXT` 从 txt 覆盖导入。
- 面板可最小化：最小化后左上角仅显示一个小 `+`，点击可展开。

### 6.5 导出 AI 友好提示词（Export）
右键某个节点点击 `Export` 后，会生成并导出一个 txt，内容包含：
- `System Prompt`
- `World Document`
- 该节点所有上游节点（沿有向边逆向可达）的所有非空 `memory block`
- 本节点的 `Text`

该导出文件适合直接作为 AI 创作提示词使用，用于保持世界观一致性。

## 7. 数据保存
- **Save**：保存当前进度到 JSON 文件。
- **Save As**：另存为新的 JSON 文件。
- **Open**：打开已有的 JSON 项目文件。

## 8. 常见问题
- **Q: 为什么导入的节点比文本里的少？**
  A: 系统启用了冲突检测。如果文本中的时间点在当前图谱中已经存在，重复的事件会被自动跳过。
- **Q: 节点拖到了画布外面怎么办？**
  A: 画布是无限的，您可以直接用 WASD 或滚动条追过去，或者点击 `Go to Start` 回到原点。
